name: Monitor Render Deployments

on:
  # Run after preview environment is created
  workflow_run:
    workflows: ["PR Preview Environment"]
    types:
      - completed
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Service name to check (optional)'
        required: false
        type: string

  # Run periodically to check production
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  check-deployments:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Check Render deployments
        id: check
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OWNER_ID: ${{ secrets.RENDER_OWNER_ID }}
        run: |
          echo "ğŸ” Checking Render.com deployments..."
          cd scripts
          node check-render-deployments.js 2>&1 | tee deployment-check.log
          
          # Capture exit code
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Save log for later use
          cat deployment-check.log > $GITHUB_STEP_SUMMARY
          
          exit $EXIT_CODE

      - name: Comment on PR if errors found
        if: failure() && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get PR number from the workflow run
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.workflow_run.head_sha,
            });
            
            if (pullRequests.data.length === 0) {
              console.log('No PR found for this commit');
              return;
            }
            
            const prNumber = pullRequests.data[0].number;
            
            // Read deployment check log
            let logContent = 'Deployment check failed. See workflow logs for details.';
            try {
              logContent = fs.readFileSync('scripts/deployment-check.log', 'utf8');
            } catch (e) {
              console.log('Could not read log file:', e);
            }
            
            const comment = `## âš ï¸ Render.com Deployment Issues Detected
            
            The automated deployment monitoring has detected issues with your Render.com deployment.
            
            ### Error Details
            
            \`\`\`
            ${logContent.substring(0, 4000)}
            \`\`\`
            
            ### Recommended Actions
            
            1. ğŸ” Review the error logs above to identify the issue
            2. ğŸ”§ Fix the identified issues in your code
            3. ğŸ’¾ Push a new commit to trigger redeployment
            4. ğŸ¤– Use MCP tools for detailed analysis:
               - Connect Claude Code or Cursor to this repository
               - Use the Render MCP server to get detailed logs
               - Ask the AI to analyze and suggest fixes
            
            ### Using MCP Tools
            
            If you have Claude Code, Cursor, or GitHub Copilot configured with MCP:
            
            1. Ensure \`RENDER_API_KEY\` is set in your environment
            2. The MCP server will automatically provide deployment information
            3. Ask: "Check the latest Render deployment errors and suggest fixes"
            
            ### Links
            
            - [Render Dashboard](https://dashboard.render.com)
            - [Workflow Run](${context.payload.workflow_run.html_url})
            - [MCP Setup Guide](../blob/main/docs/MCP_SETUP.md)
            
            ---
            ğŸ¤– *This comment was automatically generated by the Render deployment monitoring system*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Create issue if production deployment fails
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read deployment check log
            let logContent = 'Deployment check failed. See workflow logs for details.';
            try {
              logContent = fs.readFileSync('scripts/deployment-check.log', 'utf8');
            } catch (e) {
              console.log('Could not read log file:', e);
            }
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'render-deployment-error',
            });
            
            if (issues.data.length > 0) {
              console.log('Issue already exists for deployment errors');
              return;
            }
            
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Render.com Production Deployment Errors Detected',
              body: `## Production Deployment Issues
              
            Automated monitoring has detected errors in the production deployment on Render.com.
            
            ### Error Details
            
            \`\`\`
            ${logContent.substring(0, 4000)}
            \`\`\`
            
            ### Immediate Actions Required
            
            1. ğŸ” Investigate the error logs
            2. ğŸ”§ Fix critical issues
            3. ğŸš€ Deploy hotfix if necessary
            4. ğŸ“Š Monitor the deployment status
            
            ### Links
            
            - [Render Dashboard](https://dashboard.render.com)
            - [Workflow Run](${context.payload.workflow_run?.html_url || 'N/A'})
            
            ---
            ğŸ¤– *This issue was automatically created by the deployment monitoring system*
            Detected at: ${new Date().toISOString()}
            `,
              labels: ['render-deployment-error', 'bug', 'production'],
            });
