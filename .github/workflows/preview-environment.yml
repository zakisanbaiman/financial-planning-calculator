name: PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  preview-info:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment Preview URLs
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const comment = `## ğŸš€ Preview Environment
            
            Your PR preview environment is being deployed on Render.com!
            
            ### Preview URLs (available after deployment completes):
            - ğŸŒ Frontend: \`https://financial-planning-frontend-pr-${prNumber}.onrender.com\`
            - ğŸ”§ Backend API: \`https://financial-planning-backend-pr-${prNumber}.onrender.com\`
            - ğŸ“Š API Docs: \`https://financial-planning-backend-pr-${prNumber}.onrender.com/swagger/index.html\`
            
            ### What happens next:
            1. â³ Render.com will automatically deploy your changes
            2. âœ… Once deployed, you'll receive a notification
            3. ğŸ¯ Review your changes in a live environment
            4. ğŸ—‘ï¸ The preview environment will be automatically deleted 7 days after the PR is closed
            
            ### Useful Links:
            - [Render.com Dashboard](https://dashboard.render.com)
            - [Setup Guide](../blob/main/DEV_ENVIRONMENT_SETUP.md)
            
            ---
            ğŸ’¡ **Note**: First deployment may take 5-10 minutes. Subsequent deployments are faster.
            âš ï¸ **Free Tier**: The preview environment may sleep after 15 minutes of inactivity. First request may take a few seconds to wake up.
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dockerfile-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfiles
        run: |
          echo "ğŸ” Validating Dockerfile configurations..."
          
          # Check frontend Dockerfile exists and is valid
          if [ ! -f "frontend/Dockerfile.prod" ]; then
            echo "âŒ frontend/Dockerfile.prod not found"
            exit 1
          fi
          echo "âœ… frontend/Dockerfile.prod found"
          
          # Check backend Dockerfile exists and is valid
          if [ ! -f "backend/Dockerfile" ]; then
            echo "âŒ backend/Dockerfile not found"
            exit 1
          fi
          echo "âœ… backend/Dockerfile found"
          
          # Check backend start.sh exists
          if [ ! -f "backend/start.sh" ]; then
            echo "âŒ backend/start.sh not found"
            exit 1
          fi
          echo "âœ… backend/start.sh found"
          
          # Check render.yaml exists
          if [ ! -f "render.yaml" ]; then
            echo "âŒ render.yaml not found"
            exit 1
          fi
          echo "âœ… render.yaml found"
          
          echo ""
          echo "âœ… All configuration files present"
          echo "â„¹ï¸  Actual builds will be performed by Render.com"
